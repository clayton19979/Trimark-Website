<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Trimark Industries - Connect Your Wallet</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
    <div class="stars"></div>
    <div class="twinkling"></div>
    
    <div class="landing-container">
        <div class="landing-content">
            <!-- Logo Section -->
            <div class="landing-logo">
                <img src="ChatGPT_Image_Jul_3_2025_08_34_57_PM.png" alt="Trimark Industries Logo" class="logo-image">
                <h1 class="company-name">TRIMARK INDUSTRIES</h1>
                <p class="company-slogan">Forging the Future in EVE Frontier</p>
            </div>

            <!-- Wallet Connection Section -->
            <div class="wallet-connection-section">
                <h2 class="connection-title">üîí WALLET REQUIRED</h2>
                <p class="connection-description">Connect your wallet to access the Trimark Industries portal</p>
                
                <!-- Connection Status -->
                <div id="connectionStatus" class="connection-status">
                    <div class="status-icon">üîç</div>
                    <div class="status-text">Detecting available wallets...</div>
                </div>

                <!-- Connect Button -->
                <button id="connectWalletBtn" class="connect-wallet-btn" disabled>
                    <span class="btn-icon">üîó</span>
                    <span class="btn-text">Connect Wallet</span>
                </button>

                <!-- Supported Wallets Info -->
                <div class="supported-wallets">
                    <h3>Supported Wallets</h3>
                    <div class="wallet-list">
                        <div class="wallet-item">
                            <span class="wallet-icon">ü¶ä</span>
                            <span class="wallet-name">MetaMask</span>
                        </div>
                        <div class="wallet-item">
                            <span class="wallet-icon">üîë</span>
                            <span class="wallet-name">OneKey</span>
                        </div>
                        <div class="wallet-item">
                            <span class="wallet-icon">‚ö°</span>
                            <span class="wallet-name">Other EIP-6963 Wallets</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Animation -->
            <div id="loadingAnimation" class="loading-animation hidden">
                <div class="spinner"></div>
                <p>Connecting to wallet...</p>
            </div>

                    <!-- Welcome Screen (shown after successful connection) -->
        <div id="welcomeScreen" class="welcome-screen hidden">
            <div class="welcome-content">
                <div class="welcome-header">
                    <h2>üéâ Welcome to Trimark Industries!</h2>
                </div>
                <div class="welcome-body">
                    <div class="welcome-user-info">
                        <img id="welcomeUserPortrait" src="" alt="Character Portrait" class="welcome-portrait">
                        <div class="welcome-user-details">
                            <h3 id="welcomeUserName" class="welcome-user-name">Loading...</h3>
                            <div id="welcomeUserRole" class="welcome-user-role">Loading role...</div>
                        </div>
                    </div>
                    <div class="welcome-message">
                        <p>Welcome back, Commander! You have successfully connected your wallet.</p>
                        <p>Your role: <strong id="welcomeRoleDisplay">Loading...</strong></p>
                        <p>Click the button below to continue to the main site.</p>
                    </div>
                    <button id="continueToSiteBtn" class="continue-btn">
                        <span class="btn-icon">üöÄ</span>
                        <span class="btn-text">Continue to Site</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Tribe Verification Screen -->
        <div id="tribeVerificationScreen" class="tribe-verification-screen" style="display: none;">
            <div class="tribe-verification-content">
                <div class="tribe-verification-header">
                    <h2>Access Restricted</h2>
                </div>
                <div class="tribe-verification-icon">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        <path d="M9 12l2 2 4-4"/>
                    </svg>
                </div>
                <div class="tribe-verification-message">
                    <p>You are not currently a member of the Trimark tribe.</p>
                    <p>To access this site, you need to join our Discord server and get verified.</p>
                </div>
                <div class="tribe-verification-discord">
                    <a href="https://discord.gg/7ym36qS9" target="_blank" class="discord-btn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418z"/>
                        </svg>
                        Join Discord for Verification
                    </a>
                </div>
                <div class="tribe-verification-note">
                    <p>After joining Discord, contact an administrator to get verified and gain access to the site.</p>
                </div>
            </div>
        </div>
        </div>
    </div>

    <script>
        // Global variables
        let onekeyProvider = null;
        let isConnecting = false;

        // Initialize the landing page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Landing page initialized');
            initializeWalletDetection();
        });

        // Initialize wallet detection
        function initializeWalletDetection() {
            console.log('üîç Initializing wallet detection...');
            
            // Check for MetaMask first
            if (typeof window.ethereum !== 'undefined') {
                console.log('‚úÖ MetaMask detected');
                handleWalletDetected('metamask');
                return;
            }
            
            // Check for OneKey via EIP-6963
            const onAnnounceProvider = (event) => {
                console.log('üîç Wallet provider announced:', event.detail.info);
                
                if (event.detail.info.name === 'OneKey') {
                    onekeyProvider = event.detail.provider;
                    console.log('‚úÖ OneKey wallet detected via EIP-6963!');
                    handleWalletDetected('onekey');
                }
            };

            // Listen for EIP-6963 announcements
            window.addEventListener('eip6963:announceProvider', onAnnounceProvider);
            
            // Request providers
            window.dispatchEvent(new Event('eip6963:requestProvider'));
            
            // Check after delay
            setTimeout(() => {
                if (!onekeyProvider && !window.ethereum) {
                    console.log('‚ùå No wallet detected');
                    handleNoWalletDetected();
                }
            }, 1000);
        }

        // Handle wallet detection
        function handleWalletDetected(walletType) {
            console.log(`‚úÖ ${walletType} wallet detected`);
            updateConnectionStatus(`‚úÖ ${walletType.charAt(0).toUpperCase() + walletType.slice(1)} detected!`, 'success');
            enableConnectButton();
            
            // Auto-connect after a short delay
            setTimeout(() => {
                if (!isConnecting) {
                    connectWallet(walletType);
                }
            }, 1500);
        }

        // Handle no wallet detected
        function handleNoWalletDetected() {
            console.log('‚ùå No wallet detected');
            updateConnectionStatus('‚ùå No wallet detected. Please install MetaMask or OneKey.', 'error');
            enableConnectButton();
        }

        // Update connection status
        function updateConnectionStatus(message, type = 'info') {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                const statusIcon = statusElement.querySelector('.status-icon');
                const statusText = statusElement.querySelector('.status-text');
                
                statusText.textContent = message;
                statusElement.className = `connection-status ${type}`;
                
                // Update icon based on type
                if (type === 'success') {
                    statusIcon.textContent = '‚úÖ';
                } else if (type === 'error') {
                    statusIcon.textContent = '‚ùå';
                } else if (type === 'connecting') {
                    statusIcon.textContent = 'üîå';
                }
            }
        }

        // Enable connect button
        function enableConnectButton() {
            const connectBtn = document.getElementById('connectWalletBtn');
            if (connectBtn) {
                connectBtn.disabled = false;
                connectBtn.textContent = 'Connect Wallet';
                connectBtn.addEventListener('click', () => {
                    const walletType = window.ethereum ? 'metamask' : 'onekey';
                    connectWallet(walletType);
                });
            }
        }

        // Connect wallet
        async function connectWallet(walletType) {
            if (isConnecting) return;
            
            isConnecting = true;
            console.log(`üîå Connecting to ${walletType} wallet...`);
            
            try {
                // Show loading animation
                showLoadingAnimation();
                updateConnectionStatus('üîå Connecting to wallet...', 'connecting');
                
                let provider;
                if (walletType === 'metamask') {
                    provider = window.ethereum;
                } else if (walletType === 'onekey') {
                    provider = onekeyProvider;
                } else {
                    throw new Error('Unknown wallet type');
                }

                // Request account access
                const accounts = await provider.request({ method: 'eth_requestAccounts' });
                
                if (accounts && accounts.length > 0) {
                    const account = accounts[0];
                    console.log('‚úÖ Wallet connected successfully:', account);
                    
                                    // Store connection info
                localStorage.setItem('walletConnected', 'true');
                localStorage.setItem('walletType', walletType);
                localStorage.setItem('walletAccount', account);
                
                // Show success message
                updateConnectionStatus('‚úÖ Wallet connected! Loading user data...', 'success');
                
                // Fetch user data and show welcome screen
                try {
                    const userData = await fetchEveFrontierData(account);
                    if (userData) {
                        // Check if user belongs to Trimark tribe (ID: 98000063)
                        // Convert both to strings for comparison to handle type mismatches
                        const userTribeId = String(userData.tribeId);
                        const requiredTribeId = '98000063';
                        const hasAccess = userTribeId === requiredTribeId;
                        
                        if (hasAccess) {
                            showWelcomeScreen(userData, account);
                        } else {
                            showTribeVerificationScreen(userData);
                        }
                    } else {
                        // Fallback if API fails - show tribe verification
                        showTribeVerificationScreen(null);
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    // Fallback if API fails - show tribe verification
                    showTribeVerificationScreen(null);
                }
                    
                } else {
                    throw new Error('No accounts found');
                }
                
            } catch (error) {
                console.error('‚ùå Wallet connection failed:', error);
                updateConnectionStatus(`‚ùå Connection failed: ${error.message}`, 'error');
                hideLoadingAnimation();
                isConnecting = false;
            }
        }

        // Show loading animation
        function showLoadingAnimation() {
            const loading = document.getElementById('loadingAnimation');
            if (loading) {
                loading.classList.remove('hidden');
            }
        }

        // Hide loading animation
        function hideLoadingAnimation() {
            const loading = document.getElementById('loadingAnimation');
            if (loading) {
                loading.classList.add('hidden');
            }
        }

        // Fetch EVE Frontier data
        async function fetchEveFrontierData(address) {
            try {
                const response = await fetch(`https://world-api-stillness.live.tech.evefrontier.com/v2/smartcharacters/${address}?format=json`, {
                    method: 'GET',
                    headers: {
                        'accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('EVE Frontier data:', data);
                return data;
                
            } catch (error) {
                console.error('Error fetching EVE Frontier data:', error);
                return null;
            }
        }

        // Show welcome screen with user data
        function showWelcomeScreen(userData, account) {
            console.log('üéâ Showing welcome screen for:', userData.name);
            
            // Hide loading and connection sections
            hideLoadingAnimation();
            document.querySelector('.wallet-connection-section').classList.add('hidden');
            
            // Update welcome screen with user data
            const userPortrait = document.getElementById('welcomeUserPortrait');
            const userName = document.getElementById('welcomeUserName');
            const userRole = document.getElementById('welcomeUserRole');
            const roleDisplay = document.getElementById('welcomeRoleDisplay');
            
            // Set user portrait
            userPortrait.src = userData.portraitUrl || 'https://artifacts.evefrontier.com/portraits/PortraitAwakened256.png';
            userPortrait.alt = `${userData.name}'s Portrait`;
            
            // Set user name
            userName.textContent = userData.name || 'Unknown Character';
            
            // Set user role (default to Member if no role assigned)
            const roleText = 'üë§ Member'; // Default role for all users
            userRole.innerHTML = roleText;
            roleDisplay.textContent = 'Member';
            
            // Show welcome screen
            const welcomeScreen = document.getElementById('welcomeScreen');
            welcomeScreen.classList.remove('hidden');
            
            // Setup continue button
            const continueBtn = document.getElementById('continueToSiteBtn');
            continueBtn.addEventListener('click', () => {
                console.log('üöÄ User clicked continue, redirecting to main site...');
                window.location.href = 'index.html';
            });
        }

        // Fallback welcome screen if API fails
        function showWelcomeScreenFallback(account) {
            console.log('‚ö†Ô∏è Using fallback welcome screen for:', account);
            
            // Hide loading and connection sections
            hideLoadingAnimation();
            document.querySelector('.wallet-connection-section').classList.add('hidden');
            
            // Update welcome screen with basic info
            const userName = document.getElementById('welcomeUserName');
            const userRole = document.getElementById('welcomeUserRole');
            const roleDisplay = document.getElementById('welcomeRoleDisplay');
            
            // Set user name (shortened address)
            userName.textContent = `${account.substring(0, 6)}...${account.substring(account.length - 4)}`;
            
            // Set default role
            const roleText = 'üë§ Member';
            userRole.innerHTML = roleText;
            roleDisplay.textContent = 'Member';
            
            // Show welcome screen
            const welcomeScreen = document.getElementById('welcomeScreen');
            welcomeScreen.classList.remove('hidden');
            
            // Setup continue button
            const continueBtn = document.getElementById('continueToSiteBtn');
            continueBtn.addEventListener('click', () => {
                console.log('üöÄ User clicked continue, redirecting to main site...');
                window.location.href = 'index.html';
            });
        }

        // Show tribe verification screen for non-Trimark members
        function showTribeVerificationScreen(userData) {
            console.log('üö´ Showing tribe verification screen for non-Trimark member');
            
            // Hide loading and connection sections
            hideLoadingAnimation();
            document.querySelector('.wallet-connection-section').classList.add('hidden');
            
            // Show tribe verification screen
            const tribeVerificationScreen = document.getElementById('tribeVerificationScreen');
            tribeVerificationScreen.style.display = 'flex';
            
            // Clear any stored connection data since access is denied
            localStorage.removeItem('walletConnected');
            localStorage.removeItem('walletAccount');
            localStorage.removeItem('walletType');
        }
    </script>
</body>
</html>
