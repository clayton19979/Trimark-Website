<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Trimark Industries - Connect Your Wallet</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
    <div class="stars"></div>
    <div class="twinkling"></div>
    
    <div class="landing-container">
        <div class="landing-content">
            <!-- Logo Section -->
            <div class="landing-logo">
                <img src="ChatGPT_Image_Jul_3_2025_08_34_57_PM.png" alt="Trimark Industries Logo" class="logo-image">
                <h1 class="company-name">TRIMARK INDUSTRIES</h1>
                <p class="company-slogan">Forging the Future in EVE Frontier</p>
            </div>

            <!-- Wallet Connection Section -->
            <div class="wallet-connection-section">
                <h2 class="connection-title">üîí WALLET REQUIRED</h2>
                <p class="connection-description">Connect your wallet to access the Trimark Industries portal</p>
                
                <!-- Connection Status -->
                <div id="connectionStatus" class="connection-status">
                    <div class="status-icon">üîç</div>
                    <div class="status-text">Detecting available wallets...</div>
                </div>

                <!-- Connect Button -->
                <button id="connectWalletBtn" class="connect-wallet-btn" disabled>
                    <span class="btn-icon">üîó</span>
                    <span class="btn-text">Connect Wallet</span>
                </button>

                <!-- Supported Wallets Info -->
                <div class="supported-wallets">
                    <h3>Supported Wallets</h3>
                    <div class="wallet-list">
                        <div class="wallet-item">
                            <span class="wallet-icon">ü¶ä</span>
                            <span class="wallet-name">MetaMask</span>
                        </div>
                        <div class="wallet-item">
                            <span class="wallet-icon">üîë</span>
                            <span class="wallet-name">OneKey</span>
                        </div>
                        <div class="wallet-item">
                            <span class="wallet-icon">‚ö°</span>
                            <span class="wallet-name">Other EIP-6963 Wallets</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Animation -->
            <div id="loadingAnimation" class="loading-animation hidden">
                <div class="spinner"></div>
                <p>Connecting to wallet...</p>
            </div>

            <!-- Welcome Screen (shown after successful connection) -->
            <div id="welcomeScreen" class="welcome-screen hidden">
                <div class="welcome-content">
                    <div class="welcome-header">
                        <h2>üéâ Welcome to Trimark Industries!</h2>
                    </div>
                    <div class="welcome-body">
                        <div class="welcome-user-info">
                            <img id="welcomeUserPortrait" src="" alt="Character Portrait" class="welcome-portrait">
                            <div class="welcome-user-details">
                                <h3 id="welcomeUserName" class="welcome-user-name">Loading...</h3>
                                <div id="welcomeUserRole" class="welcome-user-role">Loading role...</div>
                            </div>
                        </div>
                        <div class="welcome-message">
                            <p>Welcome back, Commander! You have successfully connected your wallet.</p>
                            <p>Your role: <strong id="welcomeRoleDisplay">Loading...</strong></p>
                            <p>Click the button below to continue to the main site.</p>
                        </div>
                        <button id="continueToSiteBtn" class="continue-btn">
                            <span class="btn-icon">üöÄ</span>
                            <span class="btn-text">Continue to Site</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let onekeyProvider = null;
        let isConnecting = false;

        // Initialize the landing page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Landing page initialized');
            initializeWalletDetection();
        });

        // Initialize wallet detection
        function initializeWalletDetection() {
            console.log('üîç Initializing wallet detection...');
            
            // Check for MetaMask first
            if (typeof window.ethereum !== 'undefined') {
                console.log('‚úÖ MetaMask detected');
                handleWalletDetected('metamask');
                return;
            }
            
            // Check for OneKey via EIP-6963
            const onAnnounceProvider = (event) => {
                console.log('üîç Wallet provider announced:', event.detail.info);
                
                if (event.detail.info.name === 'OneKey') {
                    onekeyProvider = event.detail.provider;
                    console.log('‚úÖ OneKey wallet detected via EIP-6963!');
                    handleWalletDetected('onekey');
                }
            };

            // Listen for EIP-6963 announcements
            window.addEventListener('eip6963:announceProvider', onAnnounceProvider);
            
            // Request providers
            window.dispatchEvent(new Event('eip6963:requestProvider'));
            
            // Check after delay
            setTimeout(() => {
                if (!onekeyProvider && !window.ethereum) {
                    console.log('‚ùå No wallet detected');
                    handleNoWalletDetected();
                }
            }, 1000);
        }

        // Handle wallet detection
        function handleWalletDetected(walletType) {
            console.log(`‚úÖ ${walletType} wallet detected`);
            updateConnectionStatus(`‚úÖ ${walletType.charAt(0).toUpperCase() + walletType.slice(1)} detected!`, 'success');
            enableConnectButton();
            
            // Auto-connect after a short delay
            setTimeout(() => {
                if (!isConnecting) {
                    connectWallet(walletType);
                }
            }, 1500);
        }

        // Handle no wallet detected
        function handleNoWalletDetected() {
            console.log('‚ùå No wallet detected');
            updateConnectionStatus('‚ùå No wallet detected. Please install MetaMask or OneKey.', 'error');
            enableConnectButton();
        }

        // Update connection status
        function updateConnectionStatus(message, type = 'info') {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                const statusIcon = statusElement.querySelector('.status-icon');
                const statusText = statusElement.querySelector('.status-text');
                
                statusText.textContent = message;
                statusElement.className = `connection-status ${type}`;
                
                // Update icon based on type
                if (type === 'success') {
                    statusIcon.textContent = '‚úÖ';
                } else if (type === 'error') {
                    statusIcon.textContent = '‚ùå';
                } else if (type === 'connecting') {
                    statusIcon.textContent = 'üîå';
                }
            }
        }

        // Enable connect button
        function enableConnectButton() {
            const connectBtn = document.getElementById('connectWalletBtn');
            if (connectBtn) {
                connectBtn.disabled = false;
                connectBtn.textContent = 'Connect Wallet';
                connectBtn.addEventListener('click', () => {
                    const walletType = window.ethereum ? 'metamask' : 'onekey';
                    connectWallet(walletType);
                });
            }
        }

        // Connect wallet
        async function connectWallet(walletType) {
            if (isConnecting) return;
            
            isConnecting = true;
            console.log(`üîå Connecting to ${walletType} wallet...`);
            
            try {
                // Show loading animation
                showLoadingAnimation();
                updateConnectionStatus('üîå Connecting to wallet...', 'connecting');
                
                let provider;
                if (walletType === 'metamask') {
                    provider = window.ethereum;
                } else if (walletType === 'onekey') {
                    provider = onekeyProvider;
                } else {
                    throw new Error('Unknown wallet type');
                }

                // Request account access
                const accounts = await provider.request({ method: 'eth_requestAccounts' });
                
                if (accounts && accounts.length > 0) {
                    const account = accounts[0];
                    console.log('‚úÖ Wallet connected successfully:', account);
                    
                                    // Store connection info
                localStorage.setItem('walletConnected', 'true');
                localStorage.setItem('walletType', walletType);
                localStorage.setItem('walletAccount', account);
                
                // Show success message
                updateConnectionStatus('‚úÖ Wallet connected! Loading user data...', 'success');
                
                // Fetch user data and show welcome screen
                try {
                    const userData = await fetchEveFrontierData(account);
                    if (userData) {
                        showWelcomeScreen(userData, account);
                    } else {
                        // Fallback if API fails
                        showWelcomeScreenFallback(account);
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    // Fallback if API fails
                    showWelcomeScreenFallback(account);
                }
                    
                } else {
                    throw new Error('No accounts found');
                }
                
            } catch (error) {
                console.error('‚ùå Wallet connection failed:', error);
                updateConnectionStatus(`‚ùå Connection failed: ${error.message}`, 'error');
                hideLoadingAnimation();
                isConnecting = false;
            }
        }

        // Show loading animation
        function showLoadingAnimation() {
            const loading = document.getElementById('loadingAnimation');
            if (loading) {
                loading.classList.remove('hidden');
            }
        }

        // Hide loading animation
        function hideLoadingAnimation() {
            const loading = document.getElementById('loadingAnimation');
            if (loading) {
                loading.classList.add('hidden');
            }
        }

        // Fetch EVE Frontier data
        async function fetchEveFrontierData(address) {
            try {
                const response = await fetch(`https://world-api-stillness.live.tech.evefrontier.com/v2/smartcharacters/${address}?format=json`, {
                    method: 'GET',
                    headers: {
                        'accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('EVE Frontier data:', data);
                return data;
                
            } catch (error) {
                console.error('Error fetching EVE Frontier data:', error);
                return null;
            }
        }

        // Show welcome screen with user data
        function showWelcomeScreen(userData, account) {
            console.log('üéâ Showing welcome screen for:', userData.name);
            
            // Hide loading and connection sections
            hideLoadingAnimation();
            document.querySelector('.wallet-connection-section').classList.add('hidden');
            
            // Update welcome screen with user data
            const userPortrait = document.getElementById('welcomeUserPortrait');
            const userName = document.getElementById('welcomeUserName');
            const userRole = document.getElementById('welcomeUserRole');
            const roleDisplay = document.getElementById('welcomeRoleDisplay');
            
            // Set user portrait
            userPortrait.src = userData.portraitUrl || 'https://artifacts.evefrontier.com/portraits/PortraitAwakened256.png';
            userPortrait.alt = `${userData.name}'s Portrait`;
            
            // Set user name
            userName.textContent = userData.name || 'Unknown Character';
            
            // Set user role (default to Member if no role assigned)
            const roleText = 'üë§ Member'; // Default role for all users
            userRole.innerHTML = roleText;
            roleDisplay.textContent = 'Member';
            
            // Show welcome screen
            const welcomeScreen = document.getElementById('welcomeScreen');
            welcomeScreen.classList.remove('hidden');
            
            // Setup continue button
            const continueBtn = document.getElementById('continueToSiteBtn');
            continueBtn.addEventListener('click', () => {
                console.log('üöÄ User clicked continue, redirecting to main site...');
                window.location.href = 'index.html';
            });
        }

        // Fallback welcome screen if API fails
        function showWelcomeScreenFallback(account) {
            console.log('‚ö†Ô∏è Using fallback welcome screen for:', account);
            
            // Hide loading and connection sections
            hideLoadingAnimation();
            document.querySelector('.wallet-connection-section').classList.add('hidden');
            
            // Update welcome screen with basic info
            const userName = document.getElementById('welcomeUserName');
            const userRole = document.getElementById('welcomeUserRole');
            const roleDisplay = document.getElementById('welcomeRoleDisplay');
            
            // Set user name (shortened address)
            userName.textContent = `${account.substring(0, 6)}...${account.substring(account.length - 4)}`;
            
            // Set default role
            const roleText = 'üë§ Member';
            userRole.innerHTML = roleText;
            roleDisplay.textContent = 'Member';
            
            // Show welcome screen
            const welcomeScreen = document.getElementById('welcomeScreen');
            welcomeScreen.classList.remove('hidden');
            
            // Setup continue button
            const continueBtn = document.getElementById('continueToSiteBtn');
            continueBtn.addEventListener('click', () => {
                console.log('üöÄ User clicked continue, redirecting to main site...');
                window.location.href = 'index.html';
            });
        }
    </script>
</body>
</html>
